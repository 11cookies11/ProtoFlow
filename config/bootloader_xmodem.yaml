version: 1

vars:
  block: 1
  file_path: ./firmware.bin      # 待发送的固件路径
  max_blocks: 960                # 120 KB / 128B

channels:
  boot:
    type: uart
    device: COM3                 # 替换为实际 UART3 对应串口
    baudrate: 115200

state_machine:
  initial: wait_handshake
  states:
    wait_handshake:
      do:
        - log: "等待 bootloader 发送 'C'（XMODEM-CRC 握手）"
      on_event:
        "C": send_block
      timeout: 10000
      on_timeout: fail

    send_block:
      do:
        - action: send_xmodem_block
          args:
            block: "$block"
      on_event:
        "\x06": next_block      # ACK
        "\x15": resend_block    # NAK
        "\x18": abort           # CAN（尺寸超限/致命错误）
      timeout: 2000
      on_timeout: resend_block

    resend_block:
      do:
        - log: "重发块 $block"
      goto: send_block

    next_block:
      do:
        - set: { block: "$block + 1" }
      when: "$block <= file.block_count and $block <= max_blocks"
      goto: send_block
      else_goto: send_eot

    send_eot:
      do:
        - action: send_eot
      on_event:
        "\x06": done            # ACK
        "\x18": abort
      timeout: 2000
      on_timeout: abort

    abort:
      do:
        - log: "Bootloader 返回 CAN 或超时，停止传输"
      goto: done

    fail:
      do:
        - log: "等待握手超时，未开始 XMODEM 传输"
      goto: done

    done:
      do:
        - log: "XMODEM 传输流程结束（成功需在 boot 自动跳转）"
